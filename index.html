<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Book of Eternity</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    
    <style>
      body {
        font-family: 'Inter', sans-serif;
        background-color: #0c111c;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%231a202c' fill-opacity='0.2'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      }
      .narrative-text {
        font-family: 'Lora', serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1a202c;
      }
      ::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
      /* Base styles for Tailwind Typography in dark mode */
      .prose {
        --tw-prose-body: theme(colors.gray[300]);
        --tw-prose-headings: theme(colors.cyan[400]);
        --tw-prose-lead: theme(colors.gray[400]);
        --tw-prose-links: theme(colors.cyan[400]);
        --tw-prose-bold: theme(colors.white);
        --tw-prose-counters: theme(colors.gray[400]);
        --tw-prose-bullets: theme(colors.cyan[400]);
        --tw-prose-hr: theme(colors.gray[700]);
        --tw-prose-quotes: theme(colors.gray[300]);
        --tw-prose-quote-borders: theme(colors.cyan[500]);
        --tw-prose-captions: theme(colors.gray[500]);
        --tw-prose-code: theme(colors.cyan[300]);
        --tw-prose-pre-code: theme(colors.cyan[300]);
        --tw-prose-pre-bg: theme(colors.gray[900]);
        --tw-prose-th-borders: theme(colors.gray[600]);
        --tw-prose-td-borders: theme(colors.gray[700]);
      }
      /* Custom CSS for fixing modal font size scaling with prose */
      .text-xs .prose { font-size: 0.75rem; }
      .text-sm .prose { font-size: 0.875rem; }
      .text-base .prose { font-size: 1rem; }
      .text-lg .prose { font-size: 1.125rem; }
      .text-xl .prose { font-size: 1.25rem; }
      .text-2xl .prose { font-size: 1.5rem; }
      /* For the new map view */
      .map-viewport {
        background-color: #f3e9d2; /* parchment color */
        background-image:
          linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px),
          linear-gradient(rgba(0,0,0,0.03) .5px, transparent .5px),
          linear-gradient(90deg, rgba(0,0,0,0.03) .5px, transparent .5px);
        background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;
        border: 10px solid #c6b89e;
        border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='30' height='30'%3E%3Cpath d='M0,0 V30 H30 V0 Z' fill='none' stroke='%23856d4b' stroke-width='2'/%3E%3C/svg%3E") 5 stretch;
        box-shadow: inset 0 0 15px rgba(0,0,0,0.3);
        overflow: hidden;
        position: relative;
        min-height: 400px; /* Ensure it has some height */
        border-radius: 4px;
        cursor: grab;
        user-select: none;
      }
      .map-viewport.is-panning {
        cursor: grabbing;
      }
      .map-transform-wrapper {
        transform-origin: 0 0;
        transition: transform 0.2s ease-out;
        width: 100%;
        height: 100%;
      }
      .map-canvas {
        position: relative;
        width: 100%;
        height: 100%;
        min-width: 600px;
        min-height: 500px;
      }
      .map-line {
        stroke: #a0522d; /* Sienna color for path */
        stroke-width: 2;
        stroke-dasharray: 4 4;
        opacity: 0.7;
        transition: stroke 0.2s;
      }
      .map-line--undiscovered {
        stroke: #c6b89e;
        stroke-width: 1.5;
        stroke-dasharray: 2 3;
        opacity: 0.9;
      }
      .map-location {
        position: absolute;
        transform: translate(-50%, -50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        transition: transform 0.2s ease-in-out, opacity 0.2s;
      }
      .map-location:hover {
        transform: translate(-50%, -50%) scale(1.2);
        z-index: 10;
      }
      .map-location-label {
        font-family: 'Lora', serif;
        font-size: 12px;
        font-weight: bold;
        color: #5a3d2b; /* Dark brown */
        text-shadow: 1px 1px 2px #f3e9d2;
        background-color: rgba(243, 233, 210, 0.7); /* Semi-transparent parchment */
        padding: 1px 5px;
        border-radius: 3px;
        margin-top: 4px;
        white-space: nowrap;
        pointer-events: none;
      }
      .map-location--undiscovered {
        opacity: 0.6;
        filter: grayscale(50%);
      }
      .map-location--undiscovered .map-location-icon {
        color: #856d4b;
      }
      .map-location--undiscovered .map-location-label {
        font-style: italic;
        color: #856d4b;
      }
      .map-location--player .map-location-icon {
        color: #e53e3e; /* Red for player */
        animation: pulse 2s infinite;
        filter: drop-shadow(0 0 5px #e53e3e);
      }
      .map-location--player .map-location-label {
        color: #9b2c2c; /* Darker red */
      }
      @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.3); }
        100% { transform: scale(1); }
      }
      .map-tooltip {
        position: fixed;
        background-color: #fbf6e9;
        border: 2px solid #a0522d;
        border-radius: 8px;
        padding: 12px;
        color: #5a3d2b;
        max-width: 300px;
        z-index: 100;
        pointer-events: none;
        font-family: 'Lora', serif;
        box-shadow: 5px 5px 15px rgba(0,0,0,0.3);
        transform: translate(15px, 15px);
        transition: opacity 0.2s ease-in-out;
      }
      .map-tooltip-title {
        font-weight: bold;
        font-size: 1.1em;
        margin-bottom: 4px;
        border-bottom: 1px solid #c6b89e;
        padding-bottom: 4px;
      }
      .map-tooltip-desc {
        font-size: 0.9em;
        font-style: italic;
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 4;
        -webkit-box-orient: vertical;
      }
      .map-tooltip-difficulty {
        font-size: 0.9em;
        font-weight: bold;
        color: #c0392b;
        margin-top: 4px;
      }
      .map-controls {
        position: absolute;
        bottom: 10px;
        right: 10px;
        z-index: 20;
        display: flex;
        flex-direction: column;
        gap: 4px;
        background-color: rgba(133, 109, 75, 0.5);
        padding: 4px;
        border-radius: 4px;
        border: 1px solid rgba(0,0,0,0.2);
      }
      .map-control-button {
        width: 28px;
        height: 28px;
        background-color: #f3e9d2;
        border: 1px solid #a0522d;
        border-radius: 2px;
        color: #5a3d2b;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
        transition: background-color 0.2s;
      }
      .map-control-button:hover {
        background-color: #c6b89e;
      }
      .compass-rose {
        position: absolute;
        top: 15px;
        left: 15px;
        width: 60px;
        height: 60px;
        z-index: 20;
        pointer-events: none;
        opacity: 0.5;
      }
      /* Music Player */
      .music-player {
        position: fixed;
        z-index: 40;
        background-color: rgba(12, 17, 28, 0.9);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(55, 65, 81, 0.5);
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        display: flex;
        flex-direction: column;
        min-width: 280px;
        min-height: 200px;
      }
      .music-player-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background-color: rgba(31, 41, 55, 0.5);
        cursor: grab;
        flex-shrink: 0;
      }
      .music-player-header:active {
        cursor: grabbing;
      }
      .music-player-title {
        color: #9ca3af;
        font-size: 0.75rem;
        font-weight: bold;
      }
      .music-player-content {
        flex-grow: 1;
      }
      .music-player iframe {
        border: none;
        width: 100%;
        height: 100%;
      }
      .music-player-resizer {
        position: absolute;
        width: 16px;
        height: 16px;
        bottom: 0;
        right: 0;
        cursor: se-resize;
        z-index: 10;
      }
      .music-player-resizer::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 8px;
        height: 8px;
        border-bottom: 2px solid rgba(107, 114, 128, 0.7);
        border-right: 2px solid rgba(107, 114, 128, 0.7);
        opacity: 0.5;
        transition: opacity 0.2s;
      }
      .music-player-resizer:hover::after {
        opacity: 1;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://esm.sh/react@^19.0.0-rc.0/",
    "react": "https://esm.sh/react@^19.0.0-rc.0",
    "react-dom/": "https://esm.sh/react-dom@^19.0.0-rc.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.10.0",
    "@heroicons/react/": "https://esm.sh/@heroicons/react@^2.1.5/",
    "react-dom": "https://esm.sh/react-dom@^19.0.0-rc.0",
    "dompurify": "https://esm.sh/dompurify@3.1.6",
    "marked": "https://esm.sh/marked@^16.1.1"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
  <body>
    <div id="root"></div>
    <div id="modal-root"></div>
    <script type="module" src="/index.tsx"></script>
  </body>
</html>